<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<script type="text/javascript" src="http://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
  // When the page is loaded, or when the theme is switched, the data-theme has to be propagated to the g-recaptcha.
  function setRecaptchaTheme() {
    const recaptcha = document.querySelector('.g-recaptcha');
    const theme = document.documentElement.getAttribute('data-theme');

    alert(`About to set the grecaptcha to data theme ${theme}`);

    recaptcha.setAttribute('theme', theme);
    grecaptcha.render();
    // grecaptcha.setRecaptchaTheme();
    /*
    $('.g-recaptcha').attr('data-theme', theme);
    */
  }
  // document.addEventListener('DOMContentLoaded', setRecaptchaTheme);
  const observer = new MutationObserver((mutations) => {
    const changed = mutations.some(mutation =>
      mutation.type === 'attributes' && mutation.attributeName === 'data-theme');
    if (changed) {
      setRecaptchaTheme();
    }
  });
  observer.observe(document.documentElement, { attributes: true });

  // Sets feedback message.
  function setFeedback(message = '', ok = true) {
    const feedback = $('#submit-feedback');

    feedback.attr('feedback-success', ok);
    feedback.text(message);
  }
</script>

<div class="contact-form">
  <form id="contact-form" class="form-style" method="POST" action="{{ .Site.Params.contactFormAction }}">
    <ul>
      <li>
        <input class="field-style field-full" type="text" name="username" id="username" placeholder="{{ i18n "name" }}" oninvalid="setCustomValidity('{{ i18n "name_error" }}')" oninput="setCustomValidity('')" required>
      </li>
      <li>
        <input class="field-style field-full" type="email" name="email" id="email" placeholder="{{ i18n "email" }}" pattern="^[a-zA-Z0-9.!#$%&â€™*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$" oninvalid="setCustomValidity('{{ i18n "email_error" }}')" oninput="setCustomValidity('')" required>
      </li>
      <li>
        <textarea class="field-style" name="message" id="message" rows="6" placeholder="{{ i18n "message" }}" oninvalid="setCustomValidity('{{ i18n "message_error" }}')" oninput="setCustomValidity('')" required></textarea>
      </li>
      <li>
        <input class="field-style" id="form-submit" type="submit" value="{{ i18n "send" }}">
      </li>
      <li>
        <div id="submit-feedback"></div>
      </li>
    </ul>
    {{ with .Site.Params.contactFormReCaptchaSiteKey }}
      <div class="g-recaptcha" data-sitekey="{{ . }}" data-callback="onSubmit" data-size="invisible"></div>
    {{ end }}
  </form>
</div>

<script>
  // This hanlder takes care of submission post-captcha.
  function onSubmit() {
    const response = grecaptcha.getResponse();

    if(response.length == 0) { 
      setFeedback('{{ i18n "form_captcha_error" }}', false);
    } else {
      const message = $('#contact-form').serialize();

      $.ajax({
          url: '{{ .Site.Params.contactFormAction }}', 
          method: 'POST',
          data: message,
          dataType: 'json',
          success: (result) => {
            setFeedback('{{ i18n "form_success" }}');
          },
          error: (xhr) => {
            setFeedback('{{ i18n "form_submit_error" }}', false);
          },
      });

      // Reenable button.
      $('#form-submit').prop('disabled', false);
    }
  }

  // Initial contact form submit is disabled, and optionally kicks off captcha.
  $('#contact-form').submit((e) => {
    // We're doing the submission to avoid the redirect for free Formspree accounts.
    e.preventDefault();
    setFeedback('');
    // Disable submit button for the time being,
    $('#form-submit').prop('disabled', true);
    grecaptcha.execute();
  });
</script>